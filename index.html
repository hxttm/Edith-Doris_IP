<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Dream â€” Home</title>
    <link rel="stylesheet" href="phone.css" />
  </head>

  <body>
    <div class="dreampage dreamhome has-nav blue" id="pageRoot">
      <main class="dreamhome_screen" aria-label="Home">
        <header class="dreamhome_top">
          <div class="dreamhome_top_left">
            <div class="dreamhome_title">
              Hello, <span class="dreamhome_name">Edith</span>!
            </div>
          </div>

          <div class="dreamhome_top_right">
            <button type="button" class="dreamhome_gem_pill" aria-label="Gems">
              <img class="dreamhome_gem_icon" src="assets/diamond.png" alt="" />
              <span class="dreamhome_gem_count">10</span>
            </button>
          </div>
        </header>

        <section class="dreamhome_weekly" aria-label="Weekly progress">
          <div class="dreamhome_weekly_title">Weekly Progress</div>

          <div class="dreamhome_weekly_row">
            <div class="dreamhome_weekly_day" data-hours="5">
              <div class="dreamhome_weekly_dow">SUN</div>
              <div class="dreamhome_weekly_hours">5H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="3">
              <div class="dreamhome_weekly_dow">MON</div>
              <div class="dreamhome_weekly_hours">3H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="4">
              <div class="dreamhome_weekly_dow">TUE</div>
              <div class="dreamhome_weekly_hours">4H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="7">
              <div class="dreamhome_weekly_dow">WED</div>
              <div class="dreamhome_weekly_hours">7H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="2">
              <div class="dreamhome_weekly_dow">THU</div>
              <div class="dreamhome_weekly_hours">2H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="0">
              <div class="dreamhome_weekly_dow">FRI</div>
              <div class="dreamhome_weekly_hours">0H</div>
            </div>

            <div class="dreamhome_weekly_day" data-hours="0">
              <div class="dreamhome_weekly_dow">SAT</div>
              <div class="dreamhome_weekly_hours">0H</div>
            </div>
          </div>
        </section>

        <section class="dreamhome_hero" aria-label="Focus session">
          <div class="dreamhome_hero_img_wrap">
            <img
              id="dreamhome_hero_img"
              class="dreamhome_hero_img"
              src="assets/home/blue.jpg"
              alt="Study buddy"
            />
          </div>

          <div class="dreamhome_hero_actions">
            <div class="dreamhome_left_actions">
              <button type="button" class="dreamhome_pill">Daily Spin</button>
              <button type="button" class="dreamhome_pill">Leaderboard</button>
            </div>

            <div class="dreamhome_right_actions">
              <div id="homeTimer" class="dreamhome_timer" aria-label="Timer">00:00:00</div>
              <button type="button" id="homeTimerBtn" class="dreamhome_cta">Start Now</button>
            </div>
          </div>
        </section>

        <nav class="ui_nav" aria-label="Bottom navigation">
          <a class="ui_nav_item" href="./buddy.html" aria-label="Customising avatar">
            <img class="ui_nav_icon" src="./assets/nav/avatar.png" alt="" />
          </a>

          <a class="ui_nav_item" href="./market.html" aria-label="Notes market">
            <img class="ui_nav_icon" src="./assets/nav/market.png" alt="" />
          </a>

          <a class="ui_nav_item ui_nav_item_active" href="./index.html" aria-label="Home" aria-current="page">
            <img class="ui_nav_icon" src="./assets/nav/home.png" alt="" />
          </a>

          <a class="ui_nav_item" href="./chat.html" aria-label="Chat">
            <img class="ui_nav_icon" src="./assets/nav/chat.png" alt="" />
          </a>

          <a class="ui_nav_item" href="./settings.html" aria-label="Settings">
            <img class="ui_nav_icon" src="./assets/nav/settings.png" alt="" />
          </a>
        </nav>

        <section
          class="dreamhome_sheet"
          id="dreamhome_quest_sheet"
          aria-label="Active quests"
          data-state="collapsed"
        >
          <div class="dreamhome_sheet_grab" role="button" tabindex="0" aria-label="Drag to expand quests">
            <div class="dreamhome_grab_handle" aria-hidden="true"></div>
            <div class="dreamhome_sheet_title">Active Quests</div>
          </div>

          <div class="dreamhome_sheet_body" aria-hidden="true">
            <div class="dreamhome_quest_card">
              <div class="dreamhome_quest_head">
                <div class="dreamhome_quest_gems">10 Gems</div>
              </div>

              <ul class="dreamhome_quest_list">
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Complete 3 Pomodoro sessions
                </li>
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Take quick notes
                </li>
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Revise flashcards for 10 minutes
                </li>
              </ul>
            </div>

            <div class="dreamhome_quest_card">
              <div class="dreamhome_quest_head">
                <div class="dreamhome_quest_gems">20 Gems</div>
              </div>

              <ul class="dreamhome_quest_list">
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Review 1 topic summary
                </li>
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Do 20 practice questions
                </li>
                <li class="dreamhome_quest_item">
                  <span class="dreamhome_dot"></span>
                  Teach a concept (write or record a short explanation)
                </li>
              </ul>
            </div>
          </div>
        </section>
      </main>
    </div>

    <script>
      const dream_buddy = localStorage.getItem("dream_buddy") || "blue";
      const root = document.getElementById("pageRoot");
      const dreamhome_img = document.getElementById("dreamhome_hero_img");

      root?.classList.toggle("orange", dream_buddy === "orange");
      root?.classList.toggle("blue", dream_buddy !== "orange");

      if (dreamhome_img) {
        dreamhome_img.src = (dream_buddy === "orange")
          ? "assets/home/orange.png"
          : "assets/home/blue.jpg";
      }

      const tiles = document.querySelectorAll(".dreamhome_weekly_day");
      const hours = Array.from(tiles).map(t => Number(t.dataset.hours || 0));
      const max = Math.max(1, ...hours);

      tiles.forEach((tile) => {
        const h = Number(tile.dataset.hours || 0);
        const t = h / max;
        const intensity = 0.18 + (t * 0.62);
        tile.style.setProperty("--dreamhome_intensity", intensity.toFixed(3));
      });

      const sheet = document.getElementById("dreamhome_quest_sheet");
      const grab = sheet?.querySelector(".dreamhome_sheet_grab");
      const body = sheet?.querySelector(".dreamhome_sheet_body");

      const collapsed = 76;
      const expanded = 420;

      let startY = 0;
      let startH = collapsed;
      let dragging = false;

      function setHeight(h) {
        const clamped = Math.max(collapsed, Math.min(expanded, h));
        sheet?.style.setProperty("--dreamhome_sheet_h", clamped + "px");

        const isExpanded = clamped > (collapsed + expanded) / 2;
        if (sheet) sheet.dataset.state = isExpanded ? "expanded" : "collapsed";
        body?.setAttribute("aria-hidden", isExpanded ? "false" : "true");
      }

      function openSheet(){ setHeight(expanded); }
      function closeSheet(){ setHeight(collapsed); }

      function onDown(clientY) {
        if (!sheet) return;
        dragging = true;
        sheet.classList.add("dreamhome_sheet_dragging");
        startY = clientY;

        const cssH = getComputedStyle(sheet).getPropertyValue("--dreamhome_sheet_h");
        startH = parseFloat(cssH) || collapsed;
      }

      function onMove(clientY) {
        if (!dragging) return;
        const dy = startY - clientY;
        setHeight(startH + dy);
      }

      function onUp() {
        if (!dragging || !sheet) return;
        dragging = false;
        sheet.classList.remove("dreamhome_sheet_dragging");

        const cssH = getComputedStyle(sheet).getPropertyValue("--dreamhome_sheet_h");
        const h = parseFloat(cssH) || collapsed;
        (h > (collapsed + expanded) / 2) ? openSheet() : closeSheet();
      }

      grab?.addEventListener("mousedown", (e) => onDown(e.clientY));
      window.addEventListener("mousemove", (e) => onMove(e.clientY));
      window.addEventListener("mouseup", onUp);

      grab?.addEventListener("touchstart", (e) => onDown(e.touches[0].clientY), { passive: true });
      window.addEventListener("touchmove", (e) => onMove(e.touches[0].clientY), { passive: true });
      window.addEventListener("touchend", onUp);

      grab?.addEventListener("click", () => {
        if (!sheet) return;
        sheet.dataset.state === "expanded" ? closeSheet() : openSheet();
      });

      grab?.addEventListener("keydown", (e) => {
        if (!sheet) return;
        if (e.key === "Enter" || e.key === " ") {
          e.preventDefault();
          sheet.dataset.state === "expanded" ? closeSheet() : openSheet();
        }
      });

      setHeight(collapsed);

      // Timer
      const timerEl = document.getElementById("homeTimer");
      const btn = document.getElementById("homeTimerBtn");

      if (timerEl && btn) {
        let running = false;
        let startMs = 0;
        let accMs = 0;

        function fmt(ms) {
          const s = Math.floor(ms / 1000);
          const hh = String(Math.floor(s / 3600)).padStart(2, "0");
          const mm = String(Math.floor((s % 3600) / 60)).padStart(2, "0");
          const ss = String(s % 60).padStart(2, "0");
          return `${hh}:${mm}:${ss}`;
        }

        btn.addEventListener("click", () => {
          running = !running;
          btn.textContent = running ? "End Session" : "Start Now";
          if (running) startMs = Date.now();
          else accMs += (Date.now() - startMs);
        });

        function tick() {
          const total = accMs + (running ? (Date.now() - startMs) : 0);
          timerEl.textContent = fmt(total);
          requestAnimationFrame(tick);
        }
        tick();
      }
    </script>
  </body>
</html>
